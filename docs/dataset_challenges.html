---

title: Dataset Challenges


keywords: fastai
sidebar: home_sidebar

summary: "“Whoever fights monsters should see to it that in the process he does not become a monster. And if you gaze long enough into an abyss, the abyss will gaze back into you.”"
description: "“Whoever fights monsters should see to it that in the process he does not become a monster. And if you gaze long enough into an abyss, the abyss will gaze back into you.”"
nb_path: "05d_dataset_challenges.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05d_dataset_challenges.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To model real-world use cases better, we need:</p>
<ul>
<li>redundant/duplicated data;</li>
<li>noisy labels (emulating noisy oracles);</li>
<li>class imbalance;</li>
<li>out-of-distribution data/outliers included in the unlabelled data.</li>
</ul>
<p>RepeatedMNIST takes care of the first challenge.
This chapter takes care of the second one.</p>
<h2 id="Noisy-Labels">Noisy Labels<a class="anchor-link" href="#Noisy-Labels"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="nn">data</span>

<span class="kn">from</span> <span class="nn">batchbald_redux.repeated_mnist</span> <span class="kn">import</span> <span class="n">TransformedDataset</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="override_labels" class="doc_header"><code>override_labels</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>override_labels</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>indices</code></strong>:<code>list</code>, <strong><code>new_labels</code></strong>:<code>list</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="corrupt_labels" class="doc_header"><code>corrupt_labels</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L33" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>corrupt_labels</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>percentage</code></strong>:<code>int</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>generator</code></strong>:<code>Generator</code>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="corrupt_all_labels" class="doc_header"><code>corrupt_all_labels</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L47" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>corrupt_all_labels</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>num_classes</code></strong>:<code>int</code>, <strong><code>generator</code></strong>:<code>Generator</code>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">override_labels</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">indices_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">reverse_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">rank</span> <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">override_label</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">ridx</span> <span class="o">=</span> <span class="n">reverse_indices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">new_y</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_y</span>

    <span class="k">return</span> <span class="n">TransformedDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">override_label</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">corrupt_labels</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">num_corrupted</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">percentage</span> <span class="o">//</span> <span class="mi">100</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_corrupted</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_corrupted</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">updated_dataset</span> <span class="o">=</span> <span class="n">override_labels</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">new_labels</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">updated_dataset</span>


<span class="k">def</span> <span class="nf">corrupt_all_labels</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="n">new_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">override_label</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

    <span class="k">return</span> <span class="n">TransformedDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">override_label</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">zero_dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="n">noisy_dataset</span> <span class="o">=</span> <span class="n">corrupt_labels</span><span class="p">(</span><span class="n">zero_dataset</span><span class="p">,</span> <span class="n">percentage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">())</span>

<span class="nb">list</span><span class="p">(</span><span class="n">noisy_dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(tensor(0.), tensor(7)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(8)),
 (tensor(0.), tensor(5)),
 (tensor(0.), tensor(4))]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">corrupted_dataset</span> <span class="o">=</span> <span class="n">corrupt_all_labels</span><span class="p">(</span><span class="n">zero_dataset</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">())</span>

<span class="nb">list</span><span class="p">(</span><span class="n">corrupted_dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(tensor(0.), tensor(5)),
 (tensor(0.), tensor(6)),
 (tensor(0.), tensor(2)),
 (tensor(0.), tensor(5)),
 (tensor(0.), tensor(3)),
 (tensor(0.), tensor(7)),
 (tensor(0.), tensor(7)),
 (tensor(0.), tensor(9)),
 (tensor(0.), tensor(0)),
 (tensor(0.), tensor(3))]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Class-Imbalances">Class Imbalances<a class="anchor-link" href="#Class-Imbalances"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_class_indices" class="doc_header"><code>get_class_indices</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L62" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_class_indices</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>class_counts</code></strong>:<code>list</code>, <strong><code>generator</code></strong>:<code>Generator</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_imbalanced_dataset" class="doc_header"><code>get_imbalanced_dataset</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L80" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_imbalanced_dataset</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>class_counts</code></strong>:<code>list</code>, <strong><code>generator</code></strong>:<code>Generator</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_class_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">class_counts</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">):</span>
    <span class="n">class_counts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)</span>

    <span class="n">subset_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">remaining_samples</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">remaining_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">class_counts</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">subset_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">class_counts</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">subset_indices</span>


<span class="k">def</span> <span class="nf">get_imbalanced_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">class_counts</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">):</span>
    <span class="n">subset_indices</span> <span class="o">=</span> <span class="n">get_class_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">class_counts</span><span class="o">=</span><span class="n">class_counts</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">subset_indices</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>

<span class="n">imbalanced_indices</span> <span class="o">=</span> <span class="n">get_class_indices</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">class_counts</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">())</span>

<span class="n">dataset</span><span class="p">[</span><span class="n">imbalanced_indices</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(tensor(0), tensor(0)), (tensor(1), tensor(1)), (tensor(2), tensor(2)), (tensor(3), tensor(0)), (tensor(4), tensor(1)), (tensor(5), tensor(2)), (tensor(6), tensor(0)), (tensor(7), tensor(1)), (tensor(8), tensor(2))]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([1, 3, 6, 0, 7, 5]), tensor([1, 0, 0, 0, 1, 2]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mixing-in-OOD-data">Mixing in OOD data<a class="anchor-link" href="#Mixing-in-OOD-data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_ood_dataset" class="doc_header"><code>add_ood_dataset</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/dataset_challenges.py#L88" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_ood_dataset</code>(<strong><code>dataset</code></strong>:<code>Dataset</code>, <strong><code>ood_dataset</code></strong>:<code>Dataset</code>, <strong><code>ood_percentage</code></strong>:<code>int</code>, <strong><code>ood_random_labels</code></strong>:<code>bool</code>, <strong><code>generator</code></strong>:<code>Generator</code>, <strong><code>num_classes</code></strong>=<em><code>None</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">add_ood_dataset</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">ood_dataset</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">ood_percentage</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ood_random_labels</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="n">subset_ood_N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="n">ood_percentage</span> <span class="o">//</span> <span class="mi">100</span>

    <span class="n">ood_N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ood_dataset</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">subset_ood_N</span> <span class="o">&lt;=</span> <span class="n">ood_N</span>

    <span class="n">ood_indices</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ood_N</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">subset_ood_N</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ood_subset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="n">ood_dataset</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">ood_indices</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ood_random_labels</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">num_classes</span>
        <span class="n">ood_subset</span> <span class="o">=</span> <span class="n">corrupt_all_labels</span><span class="p">(</span><span class="n">ood_subset</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">ConcatDataset</span><span class="p">((</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ood_subset</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ood_dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mixed_dataset</span> <span class="o">=</span> <span class="n">add_ood_dataset</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
    <span class="n">ood_dataset</span><span class="o">=</span><span class="n">ood_dataset</span><span class="p">,</span>
    <span class="n">ood_percentage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(),</span>
    <span class="n">ood_random_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">list</span><span class="p">(</span><span class="n">mixed_dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(3), tensor(3)),
 (tensor(1), tensor(1)),
 (tensor(2), tensor(2)),
 (tensor(4), tensor(4)),
 (tensor(5), tensor(5))]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mixed_dataset2</span> <span class="o">=</span> <span class="n">add_ood_dataset</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
    <span class="n">ood_dataset</span><span class="o">=</span><span class="n">ood_dataset</span><span class="p">,</span>
    <span class="n">ood_percentage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(),</span>
    <span class="n">ood_random_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">list</span><span class="p">(</span><span class="n">mixed_dataset2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(0.), tensor(0.)),
 (tensor(3), tensor(74)),
 (tensor(5), tensor(56)),
 (tensor(4), tensor(49)),
 (tensor(2), tensor(58)),
 (tensor(1), tensor(31))]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 


---

title: Restoring Early Stopping


keywords: fastai
sidebar: home_sidebar

summary: "“The past is never where you think you left it.”"
description: "“The past is never where you think you left it.”"
nb_path: "05c_restoring_early_stopping.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05c_restoring_early_stopping.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RestoringEarlyStopping" class="doc_header"><code>class</code> <code>RestoringEarlyStopping</code><a href="https://github.com/blackhc/batchbald_redux/tree/master/batchbald_redux/restoring_early_stopping.py#L13" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RestoringEarlyStopping</code>(<strong><code>patience</code></strong>, <strong><code>score_function</code></strong>, <strong><code>training_engine</code></strong>:<code>Engine</code>, <strong><code>validation_engine</code></strong>:<code>Engine</code>, <strong><code>module</code></strong>:<code>Module</code>=<em><code>None</code></em>, <strong><code>optimizer</code></strong>:<code>Optimizer</code>=<em><code>None</code></em>, <strong><code>out_of_patience_callback</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>RestoringEarlyStopping handler can be used to stop the training if no improvement after a given number of events</p>
<p>Args:
    patience (int):
        Number of events to wait if no improvement and then stop the training
    score_function (Callable):
        It should be a function taking a single argument, an <code>ignite.engine.Engine</code> object,
        and return a score <code>float</code>. An improvement is considered if the score is higher.
    trainer (Engine):
        trainer engine to stop the run if no improvement</p>
<p>Examples:</p>
<p>.. code-block:: python</p>

<pre><code>from ignite.engine import Engine, Events
from ignite.handlers import EarlyStopping

def score_function(engine):
    val_loss = engine.state.metrics['nll']
    return -val_loss

handler = EarlyStopping(patience=10, score_function=score_function, trainer=trainer)
# Note: the handler is attached to an *Evaluator* (runs one epoch on validation dataset)
evaluator.add_event_handler(Events.COMPLETED, handler)</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ignite.engine</span> <span class="kn">import</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">Events</span>


<span class="k">class</span> <span class="nc">RestoringEarlyStopping</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RestoringEarlyStopping handler can be used to stop the training if no improvement after a given number of events</span>

<span class="sd">    Args:</span>
<span class="sd">        patience (int):</span>
<span class="sd">            Number of events to wait if no improvement and then stop the training</span>
<span class="sd">        score_function (Callable):</span>
<span class="sd">            It should be a function taking a single argument, an `ignite.engine.Engine` object,</span>
<span class="sd">            and return a score `float`. An improvement is considered if the score is higher.</span>
<span class="sd">        trainer (Engine):</span>
<span class="sd">            trainer engine to stop the run if no improvement</span>

<span class="sd">    Examples:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from ignite.engine import Engine, Events</span>
<span class="sd">        from ignite.handlers import EarlyStopping</span>

<span class="sd">        def score_function(engine):</span>
<span class="sd">            val_loss = engine.state.metrics[&#39;nll&#39;]</span>
<span class="sd">            return -val_loss</span>

<span class="sd">        handler = EarlyStopping(patience=10, score_function=score_function, trainer=trainer)</span>
<span class="sd">        # Note: the handler is attached to an *Evaluator* (runs one epoch on validation dataset)</span>
<span class="sd">        evaluator.add_event_handler(Events.COMPLETED, handler)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">patience</span><span class="p">,</span>
        <span class="n">score_function</span><span class="p">,</span>
        <span class="n">training_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">validation_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">out_of_patience_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">out_of_patience_callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">default_out_of_patience_callback</span><span class="p">():</span>
                <span class="n">training_engine</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

            <span class="n">out_of_patience_callback</span> <span class="o">=</span> <span class="n">default_out_of_patience_callback</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">score_function</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Argument score_function should be a function&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patience</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument patience should be non-negative integer&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">score_function</span> <span class="o">=</span> <span class="n">score_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_patience_callback</span> <span class="o">=</span> <span class="n">out_of_patience_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_module_state_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_optimizer_state_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_epoch</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_engine</span> <span class="o">=</span> <span class="n">training_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_engine</span> <span class="o">=</span> <span class="n">validation_engine</span>
        <span class="n">validation_engine</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">EPOCH_COMPLETED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_completed</span><span class="p">)</span>
        <span class="n">training_engine</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="n">Events</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_completed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_engine</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_module_state_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(</span><span class="n">keep_vars</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_optimizer_state_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">restore_best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_module_state_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RestoringEarlyStopping: Restoring best parameters. (Score: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_module_state_dict</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_optimizer_state_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RestoringEarlyStopping: Restoring optimizer.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_optimizer_state_dict</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">on_epoch_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_function</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RestoringEarlyStopping: </span><span class="si">%i</span><span class="s2"> / </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RestoringEarlyStopping: Out of patience&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_best</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_engine</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span>

                <span class="c1"># Reset the counter in case we keep training after adjusting the model.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_of_patience_callback</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">on_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_epoch</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_engine</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_best</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_engine</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

